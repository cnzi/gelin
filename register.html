<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>__(common.nav7)__</title>
    <link rel="shortcut icon" href="favicon.ico">

    <!-- build:css -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/register.css">
    <!-- endbuild -->
</head>

<body>
    <partial src="nav.html"></partial>

    <div class="pageNav">
        <div class="container-fulid pageNav-bg">
            <div class="title-text">
                <h1>
                    <span style='color:#ffc105;'>__(register.title1)__</span>__(register.title2)__</h1>
            </div>
        </div>
    </div>
    <div class="container main">
        <h1 class="title1">__(register.title)__</h1>
        <div class="topbar row">
            <div class="step step1 col-6">__(register.step1)__</div>
            <div class="step col-6"></div>
        </div>
    </div>
    <div class="register-form">
        <form id="register" class="needs-validation container" action="#">
            <div class="block account row">
                <div class="col-12 col-sm-12 col-lg-8 offset-lg-2">
                    <div class="form-title">__(register.idInfo)__</div>
                    <div class="form-group row">
                        <label for="account-name" class="col-12 col-sm-2">__(register.id)__</label>
                        <input id="account" type="text" class="form-control col-12 col-sm-10" name="account" required placeholder="__(register.placeholder1)__">
                    </div>
                    <div class="form-group row">
                        <label for="phone-number" class="col-12 col-sm-2">__(register.phone)__</label>
                        <select name="area_code" id="phone-code" class="phone-code form-control col-3 col-sm-2">
                        </select>
                        <input name="mobile" type="phone" id="phone" class="form-control col-9 col-sm-8" required placeholder="输入手机号">
                    </div>
                    <div class="form-group row">
                        <label for="phone-number" class="col-12 col-sm-2">__(register.verificationCode)__</label>
                        <input type="text" class="form-control col-8 col-sm-7" name="mcode" id="mcode" required placeholder="输入验证码">
                        <button id="mcodeBtn" data-loading-text="Loading..." type="button" class="btn btn-primary col-4 col-sm-3">__(register.getCode)__</button>
                    </div>
                    <div class="form-group row">
                        <label for="phone-number" class="col-12 col-sm-2">__(register.password)__</label>
                        <input type="password" id="password" class="form-control col-12 col-sm-10" name="password" required placeholder="输入密码">
                    </div>
                    <div class="form-group row">
                        <label for="phone-number" class="col-12 col-sm-2">__(register.passwordAgain)__</label>
                        <input type="password" id="password2" class="form-control col-12 col-sm-10" name="password2" required placeholder="输入密码">
                    </div>
                </div>
            </div>
            <div class="block register row">
                <div class="col-12 col-sm-10 col-lg-8 offset-sm-1 offset-lg-2">
                    <div class="form-title">__(register.regInfo)__</div>
                    <div class="form-group row">
                        <label class="col-4 col-sm-2">__(register.name)__</label>
                        <input name="real_name" id="real-name" required type="text" class="form-control col-8 col-sm-10" aria-describedby="emailHelp" placeholder="输入姓名">
                    </div>
                    <div class="form-group row">
                        <label for="gender" class="col-4 col-sm-2">__(register.sex)__</label>
                        <select name="sex" required class="form-control col-8 col-sm-10">
                            <option value="1" selected>__(register.male)__</option>
                            <option value="0">__(register.female)__</option>
                        </select>
                    </div>
                    <div class="form-group row">
                        <label class="col-4 col-sm-2">__(register.address)__</label>
                        <div class="container col-8 col-sm-10">
                            <div class="row">
                                <select id="country-list" required name="country_id" class="form-control col-4 col-sm-4">
                                    </select>
                                <select id="province-list" required name="province_id" class="form-control col-4 col-sm-4">
                                </select>
                                <select id="city-list" required name="city_id" class="form-control col-4 col-sm-4">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-4 col-sm-2">__(register.yearLevel)__</label>
                        <select name="group" required class="form-control col-8 col-sm-10">
                            <option value="1" selected>__(ranking.junior)__</option>
                            <option value="2">__(ranking.middle)__</option>
                            <option value="3">__(ranking.seniorGrade)__</option>
                            <option value="3">__(ranking.juniorHigh)__</option>
                        </select>
                    </div>
                    <div class="form-group row">
                        <label for="school" class="col-4 col-sm-2">__(register.schoolCode)__</label>
                        <input name="school_code" type="text" class="form-control col-8 col-sm-10" id="school" placeholder="输人学校码">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="terms" required>
                    <label class="read form-check-label" for="terms">__(register.read)__
                        <span class="terms"><a target="_blank" href="/portal/game/terms">__(register.terms)__</a> </span>
                    </label>
                </div>
            </div>
            <button id="submit" type="button" class="btn btn-primary btn-lg col-4">__(register.complete)__</button>
        </form>
    </div>
    <footer class="pagefooter">
        <p>__(common.footer)__</p>
    </footer>
    <script src="/assets/js/main.js "></script>
    <script src="/assets/js/jquery.tmpl.js "></script>
    <script src="/assets/js/bootstrap-datepicker.min.js"></script>
    <script id="codeTpl" type="text/x-jquery-tmpl">
        {{each(i, item) list}}
        <option value=${item.code}>${item.name}</option>
        {{/each}}
    </script>
    <script id="countryTpl" type="text/x-jquery-tmpl">
        {{each(i, item) list}}
        <option value=${item.id}>${item.name}</option>
        {{/each}}
    </script>
    <script>
        function skipInput(e) {
            var inputs = $(".form-control"); //获取登录页面的input标签
            if (e.keyCode == 13) {
                for (var i = 0; i < inputs.length; i++) {
                    //循环input标签的数量
                    if (i == (inputs.length - 1)) {
                        // 到最后一个标签
                        break;
                    } else if (e.target == inputs[i]) {
                        inputs[i + 1].focus();
                        break;
                    }
                }
            }
        }

        function loadList() {
            $.ajax({
                dataType: "json",
                url: "http://world-api.growlib.com/area/getPhoneAreaCode_json",
                success: function(r) {
                    $("#codeTpl").tmpl({
                        list: r.data.list,
                    }).appendTo("#phone-code");
                }
            });
        }
        function loadCountry(id, target) {
            $.ajax({
                dataType: "json",
                url: "http://world-api.growlib.com/area/getSubList_json?id="+id,
                success: function(r) {
                    $(target).html('')
                    $("#countryTpl").tmpl({
                        list: r.data.list,
                    }).appendTo( target || "#province-list");
                }
            });
        }
        function validate(ele) {
            $('#'+ele).removeClass('is-invalid');
            if(!$('#'+ele).val()) {
                document.getElementById(ele).scrollIntoView();
                $('#'+ele).addClass('is-invalid');
            }
        }
        $('#submit').click(function(e) {
            validate('account');
            validate('password');
            validate('password2');
            validate('mcode');
            validate('phone-code');
            validate('real-name');
            validate('phone-code');

            var password = $('#password').val();
            $('#password').removeClass('is-invalid');
            if(password.length < 6) {
                $('#password').addClass('is-invalid');
                document.getElementById('password').scrollIntoView()
                return;
            }
            if($('#password').val() !== $('#password2').val()) {
                $('#password2').addClass('is-invalid');
                document.getElementById('password').scrollIntoView()
                return;
            }
            var terms = $('#terms');
            if(!terms.is(':checked')) {
                $('#terms').addClass('is-invalid');
                return;
            }
            var query = $('#register').serialize();
            var data = {};
            var qs = query.split('&');
            var flag = false;
            for (var i = 0; i < qs.length; i++) {
                var item = qs[i].split('=');
                if (!item[1] && item[0] =='school_code') {
                    continue;
                } else if(!item[1]) {
                    flag = true;
                }
                data[item[0]] = item[1];
            }
            if(flag) {
                document.getElementById('account').scrollIntoView();
                return;
            }
            $('#mcode').removeClass('is-invalid');
            $.ajax({
                type: "POST", //方法类型
                dataType: 'json',
                url: "http://world-api.growlib.com/client/regitster/join_json", //url
                data: data,
                success: function(res) {
                    debugger
                    if(res.s === 808) {
                        document.getElementById('phone').scrollIntoView();
                        $('#mcode').addClass('is-invalid');
                    } else if(res.s === 400) {
                        alert('params lost');
                    } else if (res.s == 200) {
                        location.href = '/portal/game/complete';
                    } else if(res.s === 807) {
                        alert('Account has registered');
                    } else {
                        alert('Something error happened');
                    }
                },
                error: function(e) {
                    alert("报名异常");
                }
            });
            e.preventDefault();

        });
        var count = 60;
        $('#mcodeBtn').click(function(e) {
            var text = $(this).text();
            var $btn = $(this)
            var timer = setInterval(function() {
                $btn.text(--count);
                if(count == 0) {
                    clearInterval(timer);
                    count = 60;
                    $btn.attr("disabled",false).html(text)
                }
            }, 1000)
            var code = $('#phone-code').val();
            var mobile = $('#phone').val();
            if(!code) {
                $('#phone-code').addClass('is-invalid')
                return;
            }
            if(!mobile) {
                $('#phone').addClass('is-invalid')
                return;
            }
            $('#phone-code').removeClass('is-invalid');
            $('#phone').removeClass('is-invalid')

            $btn.attr("disabled",true)
            $.ajax({
                method: 'POST',
                dataType: "json",
                url: "http://world-api.growlib.com/sms/send_json",
                data: {
                    area_code:  code,
                    mobile: mobile
                },
                success: function(r) {
                },
                error: function(r) {
                    // $btn.attr("disabled",false).html(text)
                }
            });
        });
        // Example starter JavaScript for disabling form submissions if there are invalid fields
        (function() {
            'use strict';
            $('.form-control').keypress(skipInput);
            window.addEventListener('load', function() {
                // Fetch all the forms we want to apply custom Bootstrap validation styles to
                var forms = document.getElementsByClassName('needs-validation');
                // Loop over them and prevent submission
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
                loadList();
                loadCountry(0, '#country-list');
                loadCountry(1000001, '#province-list');
                loadCountry(2, '#city-list');
                $('#province-list').on('change', function(e) {
                    loadCountry(e.target.value, '#city-list');
                });
                $('#country-list').on('change', function(e) {
                    $('#province-list').html('').val('')
                    loadCountry(e.target.value, '#province-list');
                    $('#city-list').html('').val('')
                });
            }, false);
        })();
    </script>
</body>

</html>